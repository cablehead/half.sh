#!/bin/bash


export BIN=$(realpath $(dirname $0))

trap "stty sane" EXIT

while true ; do
    IFS= read -s -r -d '' -n 1 K

    case $K in
    "h")
        $BIN/select $1/P/N left
        ;;
    "l")
        $BIN/select $1/P/N right
        ;;
    "k")
        $BIN/select $1/P/N up
        ;;
    "j")
        $BIN/select $1/P/N down
        ;;
    "i")
        $BIN/insert $1/P
        ;;
    "|")
        $BIN/pipe $1/P/N
        ;;
    " ")
        $BIN/run $1/P/N
        ;;
    "r")
        read -e -p "refresh interval: " N
        test -z $N && rm -f $1/P/N/refresh || echo $N > $1/P/N/refresh
        ;;
    "d")
        $BIN/delete $1/P/N
        ;;
    "c")
        $BIN/clone $1/P/N
        ;;
    "*")
      T=$1/P/N/starred
      if [[ -f $T ]] ; then
        echo "unstar"
        rm -f $T
      else
        echo "star"
        touch $T
      fi
      $BIN/tree node $1/P/N >> $1/stream
      ;;
    $'\n')
        trap "exit" INT TERM
        $BIN/watch $1/P/N &
        vi $1/P/N/run
        jobs -p | xargs kill
	      sleep 0.5
        trap - INT TERM
        ;;
    *)
        echo "[$K]"
        ;;
    esac
done
