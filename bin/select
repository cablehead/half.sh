#!/bin/bash

set -e
set -u

export BIN=$(realpath $(dirname $0))

S=$(cat $1/selected)
T=$S

case $2 in
"up")
    P=$(realpath $1/node/$S/stdin)
    if [[ "$P" == "/dev/null" ]] ; then exit ; fi
    T=$(basename $(dirname $P))
    ;;
"down")
    T=$($BIN/dependson $1 $1/node/$S/stdout | head -n 1)
    if [[ -z $T ]] ; then exit ; fi
    ;;
*)
    T=$2
    ;;
esac

echo $T > $1/selected

jq --argjson id $T -n -c '{
  "selected": {"$set": ($id | tostring)}
}' >> $1/stream
